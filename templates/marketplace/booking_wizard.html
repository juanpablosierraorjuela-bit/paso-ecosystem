{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="min-h-screen bg-[#fcfcfc] py-16">
    <div class="container mx-auto px-6 max-w-4xl">
        
        <div class="mb-12">
            <a href="{% url 'salon_detail' salon.pk %}" class="group flex items-center gap-2 text-[10px] font-black tracking-widest uppercase text-gray-400 hover:text-gold transition mb-6">
                <svg class="w-4 h-4 transition group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver al Salón
            </a>
            <h1 class="text-4xl md:text-5xl font-serif font-bold text-gray-900 mb-2">Reserva tu Experiencia</h1>
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold bg-gold/10 text-gold px-3 py-1 rounded-full uppercase tracking-tighter">{{ service.name }}</span>
                <span class="text-lg font-serif italic text-gray-500">${{ service.price|floatformat:0|intcomma }}</span>
            </div>
        </div>

        <form action="{% url 'booking_commit' %}" method="POST" id="bookingForm" class="space-y-8">
            {% csrf_token %}
            <input type="hidden" name="salon_id" value="{{ salon.id }}">
            <input type="hidden" name="service_id" value="{{ service.id }}">
            <input type="hidden" name="employee_id" id="selectedEmployee">
            <input type="hidden" name="time" id="selectedTime">

            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-8 md:p-12">
                    <div class="flex items-center gap-4 mb-8">
                        <span class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold text-sm">1</span>
                        <h2 class="text-2xl font-serif font-bold text-gray-900">Selecciona tu Especialista</h2>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        {% for emp in employees %}
                        <label class="cursor-pointer group">
                            <input type="radio" name="employee_radio" value="{{ emp.id }}" class="peer sr-only" onchange="selectEmployee(this)">
                            <div class="p-6 rounded-3xl border border-gray-100 bg-gray-50/50 peer-checked:border-gold peer-checked:bg-white peer-checked:shadow-xl transition-all duration-300 text-center hover:bg-white hover:shadow-lg relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-12 h-12 bg-gold/5 rounded-full -mr-6 -mt-6 group-hover:scale-150 transition-transform"></div>
                                
                                <div class="w-16 h-16 bg-white rounded-2xl mx-auto mb-4 flex items-center justify-center font-serif text-2xl font-bold text-gold border border-gray-100 shadow-sm relative z-10">
                                    {{ emp.first_name|slice:":1" }}
                                </div>
                                <span class="text-sm font-black text-gray-900 block uppercase tracking-tight relative z-10">{{ emp.first_name }}</span>
                                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest relative z-10">Especialista</span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="p-8 md:p-12 border-t border-gray-50 bg-gray-50/30 transition-all duration-500 opacity-40 pointer-events-none" id="step2">
                    <div class="flex items-center gap-4 mb-8">
                        <span class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold text-sm">2</span>
                        <h2 class="text-2xl font-serif font-bold text-gray-900">Agenda tu Cita</h2>
                    </div>
                    
                    <div class="max-w-md mb-10">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-3 ml-1">Fecha de la sesión</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <input type="date" name="date" id="datePicker" min="{{ today }}" value="{{ today }}" 
                                   class="block w-full pl-12 pr-4 py-4 rounded-2xl bg-white border-none shadow-sm focus:ring-2 focus:ring-gold text-sm font-bold text-gray-900"
                                   onchange="fetchSlots()">
                        </div>
                    </div>

                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4 ml-1">Horarios disponibles</label>
                    <div id="slotsContainer" class="grid grid-cols-3 md:grid-cols-6 gap-3">
                        <div class="col-span-full py-10 text-center bg-white rounded-2xl border border-dashed border-gray-200">
                             <p class="text-xs text-gray-400 italic">Primero selecciona un especialista para ver las horas disponibles.</p>
                        </div>
                    </div>
                </div>

                {% if is_guest %}
                <div class="p-8 md:p-12 border-t border-gray-50 bg-white transition-all duration-500 opacity-40 pointer-events-none" id="step3">
                    <div class="flex items-center gap-4 mb-8">
                        <span class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold text-sm">3</span>
                        <h2 class="text-2xl font-serif font-bold text-gray-900">Tus Datos de Contacto</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Nombre</label>
                            <input type="text" name="first_name" required placeholder="Ej: Maria" 
                                   class="w-full px-5 py-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-gold text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Apellido</label>
                            <input type="text" name="last_name" required placeholder="Ej: Perez"
                                   class="w-full px-5 py-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-gold text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">WhatsApp</label>
                            <input type="text" name="phone" required placeholder="Ej: 300 123 4567"
                                   class="w-full px-5 py-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-gold text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Correo Electrónico</label>
                            <input type="email" name="email" required placeholder="Ej: maria@ejemplo.com"
                                   class="w-full px-5 py-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-gold text-sm font-medium">
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="px-8 md:px-12 py-10 bg-gray-900 text-white">
                    <div class="max-w-3xl mx-auto">
                        <label class="flex items-start gap-4 cursor-pointer group mb-10">
                            <input type="checkbox" required class="mt-1 w-6 h-6 bg-white/10 border-white/20 rounded text-gold focus:ring-gold focus:ring-offset-gray-900 cursor-pointer">
                            <span class="text-xs text-gray-400 leading-relaxed font-light">
                                He leído y acepto la <span class="text-white font-bold">Política de Cancelación</span>. 
                                Entiendo que para reservar debo realizar un abono previo. Si no asisto, el abono no es reembolsable. 
                                Para reprogramar sin perder el abono, debo notificar con al menos <span class="text-white font-bold underline">4 horas</span> de anticipación.
                            </span>
                        </label>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-8 pt-8 border-t border-white/10">
                            <div class="text-center md:text-left">
                                <p class="text-[10px] font-black text-gold uppercase tracking-[0.3em] mb-1">Total Abono Requerido</p>
                                <p class="text-4xl font-serif font-bold text-white">${{ deposit_amount|floatformat:0|intcomma }}</p>
                                <p class="text-[10px] text-gray-500 mt-1 italic">El saldo restante se paga en el establecimiento.</p>
                            </div>
                            
                            <button type="submit" id="submitBtn" disabled 
                                    class="w-full md:w-auto bg-gold text-black px-12 py-5 rounded-2xl font-black text-xs tracking-[0.2em] shadow-2xl shadow-gold/20 disabled:bg-gray-700 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed hover:bg-white transition-all duration-300 hover:scale-105 active:scale-95 uppercase">
                                Confirmar y Reservar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>
</div>

<script>
    let currentEmployee = null;

    function selectEmployee(radio) {
        currentEmployee = radio.value;
        document.getElementById('selectedEmployee').value = currentEmployee;
        
        const step2 = document.getElementById('step2');
        step2.classList.remove('opacity-40', 'pointer-events-none');
        step2.classList.add('bg-white');
        
        fetchSlots();
    }

    function fetchSlots() {
        if (!currentEmployee) return;
        
        const date = document.getElementById('datePicker').value;
        const container = document.getElementById('slotsContainer');
        container.innerHTML = `
            <div class="col-span-full py-10 text-center">
                <div class="inline-block w-8 h-8 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
                <p class="text-[10px] font-black text-gold uppercase tracking-widest mt-4">Buscando horarios...</p>
            </div>`;

        fetch(`{% url 'api_get_slots' %}?salon_id={{ salon.id }}&service_id={{ service.id }}&employee_id=${currentEmployee}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                if (data.slots.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full py-10 text-center bg-red-50 rounded-2xl border border-red-100">
                            <p class="text-xs text-red-600 font-bold uppercase tracking-tight">Lo sentimos, no hay disponibilidad para esta fecha.</p>
                        </div>`;
                    return;
                }

                data.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `py-4 px-2 rounded-2xl text-[11px] font-black tracking-tighter border-2 transition-all duration-300 ${
                        slot.available 
                        ? 'bg-white border-gray-100 text-gray-900 hover:border-gold hover:text-gold hover:shadow-lg' 
                        : 'bg-gray-50 border-transparent text-gray-300 cursor-not-allowed opacity-50'
                    }`;
                    btn.innerText = slot.label;
                    btn.disabled = !slot.available;
                    
                    if (slot.available) {
                        btn.onclick = () => selectTime(slot.time, btn);
                    }
                    
                    container.appendChild(btn);
                });
            });
    }

    function selectTime(time, btnElement) {
        const buttons = document.getElementById('slotsContainer').getElementsByTagName('button');
        for(let b of buttons) {
            if(!b.disabled) {
                b.classList.remove('bg-gold', 'text-black', 'border-gold', 'shadow-gold/20', 'shadow-lg');
                b.classList.add('bg-white', 'text-gray-900', 'border-gray-100');
            }
        }
        
        btnElement.classList.remove('bg-white', 'text-gray-900', 'border-gray-100');
        btnElement.classList.add('bg-gold', 'text-black', 'border-gold', 'shadow-gold/20', 'shadow-lg');

        document.getElementById('selectedTime').value = time;
        
        const step3 = document.getElementById('step3');
        const submitBtn = document.getElementById('submitBtn');
        
        if (step3) {
            step3.classList.remove('opacity-40', 'pointer-events-none');
            step3.scrollIntoView({behavior: "smooth", block: "center"});
        }
        
        submitBtn.disabled = false;
    }
</script>
{% endblock %}