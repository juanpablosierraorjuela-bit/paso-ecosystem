{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold mb-1" style="color: var(--primary);">{{ salon.name }}</h1>
            <p class="text-muted m-0">Panel de Administración</p>
        </div>
        <a href="{% url 'salon_detail' salon.slug %}" target="_blank" class="btn btn-outline-dark rounded-pill px-4 fw-bold bg-white">
            <i class="bi bi-box-arrow-up-right me-2"></i>Ver página pública
        </a>
    </div>

    <div class="d-flex justify-content-center mb-4">
        <ul class="nav nav-pills nav-pills-custom bg-white p-2 rounded-pill shadow-sm" id="dashboardTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active rounded-pill" data-bs-toggle="pill" data-bs-target="#citas">
                    <i class="bi bi-calendar-check me-2"></i>Citas
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#servicios">
                    <i class="bi bi-scissors me-2"></i>Servicios
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#equipo">
                    <i class="bi bi-people me-2"></i>Equipo
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#horarios">
                    <i class="bi bi-clock me-2"></i>Horarios
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#config">
                    <i class="bi bi-gear me-2"></i>Configuración
                </button>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="dashboardTabContent">
        
        <div class="tab-pane fade show active" id="citas">
            <div class="card-premium p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold m-0">Próximas Reservas</h4>
                    <span class="badge bg-primary rounded-pill">{{ bookings.count }} Total</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Fecha y Hora</th>
                                <th>Profesional</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in bookings %}
                            <tr>
                                <td class="fw-bold">{{ booking.customer_name }}<br><small class="text-muted fw-normal">{{ booking.customer_phone }}</small></td>
                                <td><span class="badge bg-light text-dark border">{{ booking.service.name }}</span></td>
                                <td>{{ booking.start_time|date:"D d M, H:i" }}</td>
                                <td>
                                    {% if booking.employee %}
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 25px; height: 25px; font-size: 0.7rem;">
                                                {{ booking.employee.user.first_name|first }}
                                            </div>
                                            {{ booking.employee.user.first_name }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted fst-italic">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking.status == 'confirmed' %}
                                        <span class="badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill">Confirmada</span>
                                    {% else %}
                                        <span class="badge bg-warning-subtle text-warning border border-warning px-3 py-2 rounded-pill">Pendiente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <i class="bi bi-calendar-x display-4 text-muted mb-3 d-block"></i>
                                    <p class="text-muted">No hay citas registradas aún.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="servicios">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card-premium p-4 h-100">
                        <h5 class="fw-bold mb-3">Nuevo Servicio</h5>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="create_service" value="1">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Nombre</label>
                                {{ s_form.name }}
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Duración</label>
                                    {{ s_form.duration_minutes }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Precio</label>
                                    {{ s_form.price }}
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary-custom w-100">
                                <i class="bi bi-plus-lg me-1"></i> Agregar
                            </button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="row g-3">
                        {% for service in services %}
                        <div class="col-md-6">
                            <div class="card-premium p-3 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold m-0">{{ service.name }}</h6>
                                    <small class="text-muted">{{ service.duration_minutes }} min</small>
                                </div>
                                <span class="badge bg-success fs-6">${{ service.price }}</span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <p class="text-muted">Agrega tu primer servicio para empezar.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="equipo">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-premium p-4 bg-primary text-white border-0">
                        <h5 class="fw-bold"><i class="bi bi-person-plus-fill me-2"></i>Invitar Personal</h5>
                        <p class="small opacity-75">Comparte este enlace con tus estilistas.</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control border-0" value="{{ invite_link }}" id="inviteLinkInput" readonly>
                            <button class="btn btn-light" type="button" onclick="copyLink()">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <h5 class="fw-bold mb-3">Equipo Activo</h5>
                    <div class="d-flex flex-column gap-3">
                        {% for emp in employees %}
                        <div class="card-premium p-3 d-flex align-items-center gap-3">
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center fw-bold text-primary" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                {{ emp.user.first_name|first }}
                            </div>
                            <div>
                                <h6 class="fw-bold m-0">{{ emp.user.get_full_name }}</h6>
                                <small class="text-muted">{{ emp.user.email }}</small>
                            </div>
                            <div class="ms-auto">
                                <span class="badge bg-success-subtle text-success">Activo</span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-light border">No tienes empleados registrados aún.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="horarios">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card-premium p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0">Horarios de Atención</h5>
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#formHorario">
                                <i class="bi bi-pencil me-1"></i> Editar
                            </button>
                        </div>
                        <div class="collapse mb-4" id="formHorario">
                            <div class="bg-light p-3 rounded-3">
                                <form method="post" class="row g-2 align-items-end">
                                    {% csrf_token %}
                                    <input type="hidden" name="update_hours" value="1">
                                    <div class="col-md-3">{{ h_form.weekday }}</div>
                                    <div class="col-md-3">{{ h_form.from_hour }}</div>
                                    <div class="col-md-3">{{ h_form.to_hour }}</div>
                                    <div class="col-md-2">
                                        <div class="form-check">{{ h_form.is_closed }} <label class="small">Cerrado</label></div>
                                    </div>
                                    <div class="col-md-1"><button class="btn btn-primary btn-sm w-100">OK</button></div>
                                </form>
                            </div>
                        </div>
                        <div class="list-group list-group-flush">
                            {% for h in hours %}
                            <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fw-bold">{{ h.get_weekday_display }}</span>
                                {% if h.is_closed %}
                                    <span class="badge bg-danger-subtle text-danger">Cerrado</span>
                                {% else %}
                                    <span class="fw-bold text-dark">{{ h.from_hour|time:"H:i" }} - {{ h.to_hour|time:"H:i" }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="config">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_settings" value="1">
                        <div class="card-premium p-5 mb-4">
                            <h5 class="fw-bold mb-4 text-primary">Información del Negocio</h5>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label small fw-bold">Nombre</label>{{ form.name }}</div>
                                <div class="col-md-6"><label class="form-label small fw-bold">Teléfono</label>{{ form.phone }}</div>
                                <div class="col-12"><label class="form-label small fw-bold">Dirección</label>{{ form.address }}</div>
                                <div class="col-12"><label class="form-label small fw-bold">Descripción</label>{{ form.description }}</div>
                            </div>
                        </div>
                        
                        <div class="card-premium p-5 mb-5">
                            <h5 class="fw-bold mb-4 text-accent">Integraciones</h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Bold (Pagos)</h6>
                                    {{ form.bold_api_key }}
                                    <div class="mt-2">{{ form.bold_signing_key }}</div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Telegram</h6>
                                    {{ form.telegram_bot_token }}
                                    <div class="mt-2">{{ form.telegram_chat_id }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="fixed-bottom bg-white border-top p-3 shadow-lg d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary-custom px-5 shadow">Guardar Cambios</button>
                        </div>
                    </form>
                    <div style="height: 60px;"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    function copyLink() {
        var copyText = document.getElementById("inviteLinkInput");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        alert("Enlace copiado!");
    }
</script>
{% endblock %}