{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <div class="flex justify-between items-center mb-8 border-b pb-4">
        <div>
            <h1 class="text-3xl font-serif font-bold text-gray-900">Hola, {{ user.first_name }}</h1>
            <p class="text-gray-500">Talento en <strong>{{ salon.name }}</strong></p>
        </div>
        <div class="text-right">
            <span class="bg-black text-white text-[10px] font-black px-3 py-1 rounded-full tracking-widest uppercase">
                PANEL EMPLEADO
            </span>
        </div>
    </div>

    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 rounded-xl text-xs font-bold uppercase tracking-widest {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="space-y-8">
            
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="text-sm font-black uppercase tracking-widest mb-4">Navegar Calendario</h3>
                <form method="GET" class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <select name="month" class="bg-gray-50 border-none rounded-xl text-sm p-3">
                            {% for m_num, m_name in months_range %}
                                <option value="{{ m_num }}" {% if m_num == mes_seleccionado %}selected{% endif %}>{{ m_name }}</option>
                            {% endfor %}
                        </select>
                        <select name="year" class="bg-gray-50 border-none rounded-xl text-sm p-3">
                            {% for y in years_range %}
                                <option value="{{ y }}" {% if y == anio_seleccionado %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-gray-100 hover:bg-black hover:text-white text-black font-bold py-3 rounded-xl text-xs uppercase tracking-widest transition-all">
                        Ver Mes
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-black uppercase tracking-widest">Mi Horario Semanal</h3>
                    <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-400">ISO SEMANAS</span>
                </div>

                <div class="space-y-4">
                    {% for week in weeks_info %}
                    <div class="border border-gray-100 rounded-2xl overflow-hidden">
                        <button onclick="toggleAccordion('week-{{ forloop.counter }}')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                            <span class="text-xs font-bold text-gray-700">{{ week.label }}</span>
                            <svg id="icon-week-{{ forloop.counter }}" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <div id="week-{{ forloop.counter }}" class="hidden p-4 bg-white border-t border-gray-100">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="update_week" value="1">
                                <input type="hidden" name="week_id" value="{{ week.instance.id }}">
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block">D√≠as de Trabajo</label>
                                        <div class="flex flex-wrap gap-2">
                                            {% for i, day_name in "0:Lunes,1:Martes,2:Mi√©rcoles,3:Jueves,4:Viernes,5:S√°bado,6:Domingo".splitlines %}
                                            {% with day_data=i|split_day %}
                                            <label class="relative inline-flex items-center group">
                                                <input type="checkbox" name="days" value="{{ day_data.0 }}" 
                                                    class="hidden peer" 
                                                    {% if day_data.0 in week.instance.active_days %}checked{% endif %}>
                                                <div class="px-3 py-2 bg-gray-50 text-gray-400 border border-gray-100 rounded-lg text-[10px] font-bold cursor-pointer peer-checked:bg-black peer-checked:text-white transition-all uppercase">
                                                    {{ day_data.1 }}
                                                </div>
                                            </label>
                                            {% endwith %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-[10px] font-black text-gray-400 uppercase mb-1 block">Entrada</label>
                                            <input type="time" name="work_start" value="{{ week.instance.work_start|time:'H:i' }}" class="w-full bg-gray-50 border-none rounded-lg text-sm p-2">
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-black text-gray-400 uppercase mb-1 block">Salida</label>
                                            <input type="time" name="work_end" value="{{ week.instance.work_end|time:'H:i' }}" class="w-full bg-gray-50 border-none rounded-lg text-sm p-2">
                                        </div>
                                    </div>

                                    <button type="submit" class="w-full bg-black text-white py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-gray-800 transition-all">
                                        Guardar Horario
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="text-sm font-black uppercase tracking-widest mb-6">Mi Perfil</h3>
                <form method="POST" class="custom-form">
                    {% csrf_token %}
                    <input type="hidden" name="update_profile" value="1">
                    {{ profile_form.as_p }}
                    <button type="submit" class="w-full bg-black text-white py-4 rounded-2xl text-xs font-bold uppercase tracking-widest mt-4">Actualizar Datos</button>
                </form>

                <div class="mt-10 pt-8 border-t border-dashed border-gray-100">
                    <h3 class="text-sm font-black uppercase tracking-widest mb-6">Seguridad</h3>
                    <form method="POST" class="custom-form">
                        {% csrf_token %}
                        <input type="hidden" name="change_password" value="1">
                        {{ password_form.as_p }}
                        <button type="submit" class="w-full bg-gray-100 text-black py-4 rounded-2xl text-xs font-bold uppercase tracking-widest mt-4">Cambiar Contrase√±a</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-8 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-serif font-bold text-gray-900">Pr√≥ximas Citas</h2>
                        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold mt-1">Tu agenda para este mes</p>
                    </div>
                </div>

                <div class="p-8">
                    {% for app in appointments %}
                    <div class="group relative flex items-center gap-6 p-6 mb-4 bg-white border border-gray-100 rounded-3xl hover:border-black transition-all">
                        <div class="flex-shrink-0 w-20 text-center border-r border-gray-100 pr-6">
                            <span class="block text-2xl font-serif font-bold text-gray-900">{{ app.date_time|date:"d" }}</span>
                            <span class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">{{ app.date_time|date:"M" }}</span>
                        </div>
                        
                        <div class="flex-grow">
                            <div class="flex items-center justify-between mb-1">
                                <h4 class="font-bold text-gray-900 uppercase text-sm tracking-tight">{{ app.client.get_full_name }}</h4>
                                <span class="text-[10px] font-black text-black bg-gray-100 px-3 py-1 rounded-full uppercase tracking-tighter">
                                    {{ app.date_time|date:"h:i A" }}
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">
                                {% for service in app.services.all %}
                                    {{ service.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-gray-400">
                                    <i class="far fa-clock mr-1"></i> {{ app.total_duration }} min
                                </span>
                                <span class="text-[10px] font-bold text-green-600 uppercase tracking-widest">
                                    ${{ app.total_price|intcomma }}
                                </span>
                            </div>
                        </div>

                        <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="https://wa.me/{{ app.client.phone }}" target="_blank" class="w-10 h-10 flex items-center justify-center bg-green-50 text-green-600 rounded-full hover:bg-green-600 hover:text-white transition-all">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-32 bg-gray-50 rounded-[2rem] border-dashed border-2 border-gray-200">
                        <div class="text-5xl mb-4 opacity-50">üìÖ</div>
                        <p class="text-gray-500 font-bold uppercase tracking-widest text-sm">Sin citas para este periodo</p>
                        <p class="text-gray-400 text-xs mt-2">Las citas confirmadas aparecer√°n aqu√≠ autom√°ticamente.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleAccordion(id) {
        const element = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            element.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }
</script>

<style>
    /* Estilos para formularios generados por Django */
    .custom-form p { margin-bottom: 1.25rem; }
    .custom-form label {
        display: block; font-size: 0.7rem; font-weight: 900;
        color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;
    }
    .custom-form input, .custom-form select, .custom-form textarea {
        width: 100%; padding: 0.75rem; border: 1px solid #f3f4f6;
        border-radius: 0.75rem; font-size: 0.875rem; background-color: #f9fafb;
        transition: all 0.2s; outline: none;
    }
    .custom-form input:focus { border-color: #000; background-color: #fff; }
</style>
{% endblock %}