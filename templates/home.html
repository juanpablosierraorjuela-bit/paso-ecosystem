{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="ambient-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>

<header class="hero-section">
    <div class="container">
        <h1 class="hero-title">
            Encuentra tu estilo,<br>
            reserva <span>tu tiempo</span>.
        </h1>
        <p class="hero-subtitle">
            Explora los mejores salones, spas y barberías cerca de ti. Reserva en segundos.
        </p>

        <div class="search-container">
            <div class="d-flex align-items-center flex-grow-1 px-2 border-end">
                <i class="bi bi-geo-alt text-muted fs-5"></i>
                <select id="ciudadSelect" class="search-input" onchange="filtrarCiudad()">
                    <option value="todas">Todas las ciudades</option>
                    <option value="Tunja">Tunja</option>
                    <option value="Bogota">Bogotá</option>
                    <option value="Medellin">Medellín</option>
                </select>
            </div>
            <div class="d-flex align-items-center flex-grow-1 px-2">
                <i class="bi bi-search text-muted fs-5"></i>
                <input type="text" id="nombreBusqueda" class="search-input" placeholder="¿Qué buscas hoy?" onkeyup="filtrarNombre()">
            </div>
            <button class="btn-search" onclick="usarUbicacion()">
                <i class="bi bi-crosshair"></i> Cerca
            </button>
        </div>
    </div>
</header>

<section class="container mb-5">
    <div class="row g-4" id="salonGrid">
        {% for salon in salons %}
        <div class="col-md-6 col-lg-4 salon-item" 
             data-city="{{ salon.city }}" 
             data-lat="{{ salon.latitude|default:0 }}" 
             data-lng="{{ salon.longitude|default:0 }}">
            
            <a href="{% url 'salon_detail' salon.slug %}" class="salon-card">
                {% if salon.banner %}
                    <img src="{{ salon.banner.url }}" class="card-img-top" alt="{{ salon.name }}">
                {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light text-muted">
                        <i class="bi bi-image fs-1 opacity-25"></i>
                    </div>
                {% endif %}

                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="salon-avatar">
                            {% if salon.logo %}
                                <img src="{{ salon.logo.url }}" style="width:100%; height:100%; border-radius:14px; object-fit:cover;">
                            {% else %}
                                {{ salon.name|slice:":1" }}
                            {% endif %}
                        </div>
                        
                        <div class="flex-grow-1">
                            <h5 class="card-title">{{ salon.name }}</h5>
                            <div class="card-location">
                                <i class="bi bi-geo-alt-fill text-danger small"></i> {{ salon.city }}
                            </div>
                        </div>

                        <span class="status-pill {% if salon.is_open %}status-open{% else %}status-closed{% endif %}">
                            {% if salon.is_open %}ABIERTO{% else %}CERRADO{% endif %}
                        </span>
                    </div>
                    
                    <p class="text-muted small mb-0 text-truncate">
                        {{ salon.description|default:"Sin descripción disponible." }}
                    </p>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <h3 class="text-muted fw-light">Aún no hay negocios registrados.</h3>
            <p>¡Sé el primero en unirte a PASO!</p>
            <a href="{% url 'register' %}" class="btn btn-nav-action mt-3">Registrar mi Negocio</a>
        </div>
        {% endfor %}
    </div>
</section>

<script>
    function filtrarCiudad() {
        let ciudad = document.getElementById('ciudadSelect').value;
        let items = document.querySelectorAll('.salon-item');
        items.forEach(item => {
            item.style.display = (ciudad === 'todas' || item.dataset.city === ciudad) ? 'block' : 'none';
        });
    }

    function filtrarNombre() {
        let texto = document.getElementById('nombreBusqueda').value.toLowerCase();
        let items = document.querySelectorAll('.salon-item');
        items.forEach(item => {
            let nombre = item.querySelector('.card-title').innerText.toLowerCase();
            item.style.display = nombre.includes(texto) ? 'block' : 'none';
        });
    }

    function usarUbicacion() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                let items = Array.from(document.querySelectorAll('.salon-item'));
                
                items.sort((a, b) => {
                    let distA = getDistance(userLat, userLng, a.dataset.lat, a.dataset.lng);
                    let distB = getDistance(userLat, userLng, b.dataset.lat, b.dataset.lng);
                    return distA - distB;
                });

                const grid = document.getElementById('salonGrid');
                grid.innerHTML = '';
                items.forEach(item => grid.appendChild(item));
                alert("Ordenado por cercanía a tu ubicación.");
            });
        } else {
            alert("Geolocalización no soportada.");
        }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        if(lat2 == 0 || lon2 == 0) return 99999; 
        var R = 6371; 
        var dLat = (lat2-lat1) * (Math.PI/180);
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
    }

    // Efecto Navbar Scroll
    window.addEventListener('scroll', function() {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });
</script>

{% endblock %}