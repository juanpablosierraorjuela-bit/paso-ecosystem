{% extends 'base.html' %}
{% load static %}
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23f0f0f0%22/><text x=%2250%22 y=%2250%22 font-family=%22Didot, serif%22 font-weight=%22bold%22 font-size=%2265%22 fill=%22black%22 text-anchor=%22middle%22 dy=%22.35em%22>P</text></svg>">

{% block content %}
<style>
    /* ESTILOS PROTOCOLO DIAMANTE */
    .salon-card {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid rgba(255, 255, 255, 0.4) !important;
        overflow: visible;
        background: rgba(255, 255, 255, 0.85); /* Cristal base */
    }
    .salon-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(212, 175, 55, 0.2) !important;
        border-color: #D4AF37 !important;
    }
    .salon-header-deco {
        height: 100px;
        background: linear-gradient(135deg, #1C1C1C 0%, #333333 100%);
        position: relative;
        border-radius: 20px 20px 0 0;
        overflow: hidden;
    }
    .salon-header-deco::after {
        content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.5;
    }
    .salon-avatar-container {
        width: 90px; height: 90px;
        margin: -45px auto 15px;
        position: relative; z-index: 2;
        background: rgba(255,255,255,0.9);
        padding: 5px; border-radius: 50%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .salon-avatar {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 2px solid #D4AF37;
    }
    .avatar-placeholder {
        display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #D4AF37 0%, #F5D76E 100%);
        color: #1C1C1C; font-size: 1.8rem;
    }
    .social-icon-link {
        width: 35px; height: 35px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%;
        background: rgba(212, 175, 55, 0.1); color: #D4AF37;
        transition: all 0.3s ease; text-decoration: none;
    }
    .social-icon-link:hover {
        background: #D4AF37; color: #1C1C1C; transform: scale(1.1);
    }
    .btn-reservar {
        background: linear-gradient(135deg, #1C1C1C 0%, #000 100%);
        color: white; border: none; border-radius: 50px;
    }
    .btn-reservar:hover {
        background: linear-gradient(135deg, #D4AF37 0%, #F5D76E 100%);
        color: black;
    }
    .city-coming-soon {
        background: rgba(255, 255, 255, 0.9);
        border: 2px dashed #D4AF37;
        border-radius: 20px;
        max-width: 700px;
        margin: 0 auto;
    }
    /* Estilo del buscador restaurado */
    .search-input-hero {
        border: 2px solid #D4AF37;
        padding-left: 20px;
    }
    .search-input-hero:focus {
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        border-color: #D4AF37;
    }
</style>

<div class="glass-panel p-5 mb-5 text-center position-relative overflow-hidden">
    <div class="position-relative z-1">
        <span class="badge bg-warning bg-opacity-25 text-dark mb-3 px-3 py-2 rounded-pill fw-bold" style="letter-spacing: 2px;">ECOSISTEMA EXCLUSIVO</span>
        <h1 class="display-3 fw-bold mb-3" style="font-family: 'Playfair Display';">PASO <span style="color: #D4AF37;">Ecosistem</span></h1>
        <p class="lead text-muted mb-4 mx-auto" style="max-width: 600px;">La plataforma definitiva para gestionar tu belleza.</p>
        
        <form method="GET" action="{% url 'home' %}" class="d-flex justify-content-center mx-auto mb-3" style="max-width: 500px; position: relative;">
            {% if request.GET.lat %}
                <input type="hidden" name="lat" value="{{ request.GET.lat }}">
                <input type="hidden" name="lng" value="{{ request.GET.lng }}">
            {% endif %}
            
            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                <input type="text" name="q" class="form-control search-input-hero border-0 py-3" 
                       placeholder="驴Qu茅 sal贸n o servicio buscas hoy?" 
                       value="{{ request.GET.q|default:'' }}"
                       aria-label="Buscar">
                <button class="btn btn-dark px-4 fw-bold" type="submit">
                    <i class="fas fa-search me-2"></i> Buscar
                </button>
            </div>
        </form>
        <small class="text-muted">Busca por nombre o explora los salones cercanos</small>
    </div>
</div>

<div class="container py-4" id="marketplace">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0" style="font-family: 'Playfair Display';">Nuestros Aliados</h2>
        
        {% if user_located %}
            <span class="badge bg-success text-white border px-3 py-2 rounded-pill shadow-sm">
                <i class="fas fa-map-marker-alt me-1"></i> Cerca de ti
            </span>
        {% else %}
            <span class="badge bg-white text-dark border px-3 py-2 rounded-pill shadow-sm">
                {{ salones|length }} Disponibles
            </span>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasLat = urlParams.has('lat');
            const hasQuery = urlParams.has('q');
            
            if (!hasLat && !hasQuery) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        window.location.search = `?lat=${lat}&lng=${lng}`;
                    }, function(error) {
                        console.log("Geolocalizaci贸n denegada o error: ", error);
                    });
                }
            }
        });
    </script>

    {% if salones %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for salon in salones %}
            <div class="col">
                <div class="card h-100 salon-card border-0">
                    <div class="salon-header-deco">
                        <div class="position-absolute top-0 end-0 m-3 z-2">
                            {% if salon.is_open_now_dynamic %}
                                <span class="badge bg-success bg-gradient shadow-sm px-3 py-2 rounded-pill">ABIERTO</span>
                            {% else %}
                                <span class="badge bg-dark bg-opacity-75 shadow-sm px-3 py-2 rounded-pill">CERRADO</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="salon-avatar-container">
                        {% if salon.logo %}
                            <img src="{{ salon.logo.url }}" class="salon-avatar" alt="{{ salon.name }}">
                        {% else %}
                            <div class="salon-avatar avatar-placeholder"><i class="fas fa-crown"></i></div>
                        {% endif %}
                    </div>

                    <div class="card-body text-center pt-0 px-4 pb-4">
                        <h3 class="h4 fw-bold mb-1" style="font-family: 'Playfair Display';">{{ salon.name }}</h3>
                        <p class="text-muted small mb-3 text-uppercase" style="letter-spacing: 1px;">Experiencia Premium</p>
                        
                        <div class="mb-3 text-muted small d-flex justify-content-center align-items-center gap-2">
                            <i class="fas fa-map-marker-alt" style="color: #D4AF37;"></i>
                            <span class="text-truncate" style="max-width: 200px;">{{ salon.address|default:"Ubicaci贸n Exclusiva" }}</span>
                        </div>

                        {% if salon.instagram_url or salon.whatsapp_number %}
                        <div class="d-flex justify-content-center gap-3 mb-4">
                            {% if salon.instagram_url %}
                                <a href="{{ salon.instagram_url }}" target="_blank" class="social-icon-link" title="Instagram"><i class="fab fa-instagram"></i></a>
                            {% endif %}
                            {% if salon.whatsapp_number %}
                                <a href="https://wa.me/{{ salon.whatsapp_number }}" target="_blank" class="social-icon-link" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="d-grid">
                            <a href="{% url 'booking_create' salon.slug %}" class="btn btn-reservar shadow-sm py-2 fw-bold">
                                Reservar Cita <i class="fas fa-arrow-right ms-2 small"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="city-coming-soon p-5 text-center mt-4">
            <div class="mb-4">
                <i class="fas fa-map-marked-alt fa-4x text-muted opacity-50"></i>
            </div>
            <h3 class="fw-bold mb-3" style="font-family: 'Playfair Display'; color: #333;">
                {% if request.GET.q %}
                   No encontramos salones llamados "{{ request.GET.q }}" 
                {% else %}
                   Estamos trabajando para llegar a tu ciudad 
                {% endif %}
            </h3>
            <p class="lead text-muted mx-auto mb-4" style="max-width: 600px;">
                {% if request.GET.q %}
                   Intenta con otro nombre o explora los que est谩n cerca de ti.
                {% else %}
                   隆Vaya! Parece que a煤n no tenemos aliados activos en tu ubicaci贸n actual. 
                   Estamos expandiendo nuestro ecosistema diariamente.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="https://wa.me/573228317702?text=Hola,%20quiero%20recomendar%20un%20sal贸n" target="_blank" class="btn btn-outline-dark rounded-pill px-4">
                    <i class="fab fa-whatsapp me-2"></i> Recomendar un Sal贸n
                </a>
                <a href="{% url 'register_owner' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="fas fa-handshake me-2"></i> nete a PASO
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}