{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Estilos Espec√≠ficos del Home */
    header { text-align: center; padding: 60px 20px 60px; max-width: 900px; margin: 0 auto; }
    .hero-title { font-size: 4rem; font-weight: 800; margin: 0 0 15px; line-height: 1.05; letter-spacing: -2px; background: linear-gradient(180deg, #0f172a 20%, #475569 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeUp 0.8s ease-out forwards; }
    .hero-title span { background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero-subtitle { font-size: 1.25rem; color: var(--secondary); margin-bottom: 30px; animation: fadeUp 0.8s ease-out 0.2s forwards; }
    
    .btn-legado { display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255,255,255,0.6); padding: 12px 28px; border-radius: 50px; text-decoration: none; color: #475569; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); margin-bottom: 50px; animation: fadeUp 0.8s ease-out 0.3s forwards; }
    .btn-legado:hover { background: white; border-color: #d4af37; color: #d4af37; transform: translateY(-3px); }
    
    .search-container { display: flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); padding: 8px; border-radius: 50px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.08); border: 1px solid white; width: fit-content; margin: 0 auto 60px; animation: fadeUp 0.8s ease-out 0.4s forwards; transition: transform 0.3s; }
    .search-container:hover { transform: translateY(-5px); }
    .city-select { border: none; background: transparent; padding: 12px 20px; font-family: var(--font-main); font-size: 1rem; color: var(--primary); font-weight: 600; outline: none; cursor: pointer; min-width: 200px; }
    .btn-geo { width: 48px; height: 48px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 1.2rem; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
    .btn-geo:hover { background: var(--accent); transform: rotate(15deg); }
    
    .grid-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; max-width: 1100px; margin: 0 auto; padding: 0 20px 100px; }
    .salon-card { background: white; border-radius: 28px; padding: 25px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.03); text-decoration: none; color: inherit; transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); border: 1px solid rgba(255,255,255,0.8); position: relative; overflow: hidden; display: block; animation: fadeUp 0.6s ease-out forwards; }
    .salon-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 25px 50px -10px rgba(0,0,0,0.08); z-index: 10; }
    .salon-card.hidden { display: none; }
    
    .card-header-custom { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .salon-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: var(--primary); font-size: 1.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #fff; object-fit: cover; overflow: hidden;}
    .salon-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .salon-info h3 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary); }
    .salon-info span { font-size: 0.85rem; color: #94a3b8; font-weight: 600; }
    .address { font-size: 0.95rem; color: var(--secondary); margin-bottom: 12px; line-height: 1.5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .status-pill { font-size: 0.75rem; font-weight: 800; padding: 8px 16px; border-radius: 30px; display: inline-flex; align-items: center; gap: 8px; }
    .status-pill.open { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
    .status-pill.closed { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
    
    .social-row { display: flex; gap: 10px; margin-bottom: 20px; position: relative; z-index: 5; }
    .social-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f1f5f9; color: var(--secondary); font-size: 0.95rem; transition: 0.2s; text-decoration: none; border: 1px solid #e2e8f0; }
    .social-icon:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); }
    
    @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .hero-title { font-size: 3rem; } .search-container { width: 100%; } .city-select { width: 100%; } }
</style>
{% endblock %}

{% block content %}
    <header>
        <h1 class="hero-title">Tu estilo,<br><span>tu tiempo.</span></h1>
        <p class="hero-subtitle">Reserva en los mejores salones y barber√≠as cerca de ti.<br>Sin llamadas, sin esperas.</p>
        
        <a href="https://pasotunja.com/nuestro-legado/" target="_blank" class="btn-legado">üìñ Conoce nuestro legado</a>
        
        <div class="search-container">
            <select id="city-selector" class="city-select" onchange="filtrarCiudad(this.value)">
                <option value="">üåé Ver todas las ciudades</option>
                {# Truco de Django: Agrupamos por ciudad para llenar el select autom√°ticamente #}
                {% regroup salons by city as city_list %}
                {% for c in city_list %}
                    <option value="{{ c.grouper }}">üìç {{ c.grouper }}</option>
                {% endfor %}
            </select>
            <button class="btn-geo" onclick="usarUbicacion()" title="Buscar cerca de m√≠">üìç</button>
        </div>
    </header>

    <div class="grid-wrapper" id="salon-grid">
        {% for salon in salons %}
            {# IMPORTANTE: Aseg√∫rate de tener una URL llamada 'salon_detail' en urls.py #}
            {# Si no la tienes, cambia el href a "#" temporalmente #}
            <a href="{% url 'salon_detail' salon.slug %}" class="salon-card" 
               data-lat="{{ salon.latitude|default:'0' }}" 
               data-lon="{{ salon.longitude|default:'0' }}" 
               data-ciudad="{{ salon.city }}">
                
                <div class="card-header-custom">
                    <div class="salon-avatar">
                        {% if salon.logo %}
                            <img src="{{ salon.logo.url }}" alt="{{ salon.name }}">
                        {% else %}
                            {{ salon.name|first|upper }}
                        {% endif %}
                    </div>
                    <div class="salon-info">
                        <h3>{{ salon.name }}</h3>
                        <span>{{ salon.city|default:"Tunja" }}</span>
                    </div>
                </div>
                
                <p class="address">{{ salon.address|default:"Ubicaci√≥n pendiente" }}</p>
                
                {# Redes Sociales #}
                {% if salon.instagram or salon.facebook or salon.tiktok %}
                <div class="social-row" onclick="event.preventDefault(); event.stopPropagation();"> 
                    {% if salon.instagram %} 
                        <a href="{{ salon.instagram }}" target="_blank" class="social-icon instagram" title="Instagram"><i class="fab fa-instagram"></i></a>
                    {% endif %}
                    {% if salon.facebook %} 
                        <a href="{{ salon.facebook }}" target="_blank" class="social-icon facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    {% endif %}
                    {% if salon.tiktok %} 
                        <a href="{{ salon.tiktok }}" target="_blank" class="social-icon tiktok" title="TikTok"><i class="fab fa-tiktok"></i></a>
                    {% endif %}
                </div>
                {% endif %}
                
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex; gap:8px;">
                        {# El m√©todo is_open debe existir en tu modelo Salon, si no, saldr√° CERRADO por defecto #}
                        {% if salon.is_open %}
                            <div class="status-pill open">ABIERTO</div>
                        {% else %}
                            <div class="status-pill closed">CERRADO</div>
                        {% endif %}
                    </div>
                    <span style="font-size:1.2rem; color:#cbd5e1;">‚Üí</span>
                </div>
            </a>
        {% empty %}
            <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #94a3b8;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚òï</div>
                <p>No hay salones registrados a√∫n.</p>
                <a href="{% url 'register' %}" class="btn btn-primary mt-3">Registrar mi Negocio</a>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function filtrarCiudad(ciudad) { 
        document.querySelectorAll('.salon-card').forEach(card => { 
            if (ciudad === "" || card.dataset.ciudad === ciudad) card.classList.remove('hidden'); 
            else card.classList.add('hidden'); 
        }); 
    }

    function usarUbicacion() {
        if(!navigator.geolocation) { alert("Tu navegador no soporta geolocalizaci√≥n."); return; }
        
        navigator.geolocation.getCurrentPosition(pos => {
            const myLat = pos.coords.latitude; 
            const myLon = pos.coords.longitude;
            let count = 0; 
            
            document.getElementById('city-selector').value = ""; 
            
            document.querySelectorAll('.salon-card').forEach(card => {
                const lat = parseFloat(card.dataset.lat) || 0; 
                const lon = parseFloat(card.dataset.lon) || 0;
                
                if (lat === 0 || lon === 0) return; 
                
                const dist = getDistance(myLat, myLon, lat, lon);
                
                // Muestra salones a menos de 10km (aumentado de 5km para mayor alcance)
                if(dist <= 10) { 
                    card.classList.remove('hidden'); 
                    count++; 
                } else { 
                    card.classList.add('hidden'); 
                }
            });
            
            if(count === 0) alert("No encontramos salones cercanos con coordenadas configuradas.");
        }, (error) => {
            console.error(error);
            alert("Necesitamos permiso de ubicaci√≥n para mostrarte salones cercanos.");
        });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la tierra en KM
        const dLat = (lat2-lat1)*Math.PI/180; 
        const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)* Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
</script>
{% endblock %}