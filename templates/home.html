{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="ambient-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>

<header class="hero-section">
    <div class="container">
        <h1 class="hero-title">
            Encuentra tu estilo,<br>
            reserva <span>tu tiempo</span>.
        </h1>
        <p class="hero-subtitle">
            Explora los mejores salones y barberías.
        </p>

        <div class="search-container">
            <div class="d-flex align-items-center flex-grow-1 px-2 border-end">
                <i class="bi bi-geo-alt text-muted fs-5"></i>
                <select id="ciudadSelect" class="search-input" onchange="filtrarNegocios()">
                    <option value="todas">Todas las ciudades</option>
                    {% for city in ciudades %}
                        <option value="{{ city }}">{{ city }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="d-flex align-items-center flex-grow-1 px-2">
                <i class="bi bi-search text-muted fs-5"></i>
                <input type="text" id="nombreBusqueda" class="search-input" placeholder="Buscar salón..." onkeyup="filtrarNegocios()">
            </div>
            
            <button class="btn-location-pulse" onclick="usarUbicacion()" title="Cerca de mí (600m)" data-bs-toggle="tooltip">
                <i class="bi bi-crosshair"></i>
            </button>
        </div>
    </div>
</header>

<section class="container pb-5">
    <div class="row g-4" id="salonGrid">
        {% for salon in salons %}
        <div class="col-md-6 col-lg-4 salon-item" 
             data-city="{{ salon.city|default:'' }}" 
             data-name="{{ salon.name|lower }}"
             data-lat="{{ salon.latitude|default:0 }}" 
             data-lng="{{ salon.longitude|default:0 }}">
            
            <a href="{% url 'salon_detail' salon.slug %}" class="salon-card">
                <div class="card-img-wrapper" style="height: 180px; overflow: hidden; background: #f8f9fa;">
                    {% if salon.banner %}
                        <img src="{{ salon.banner.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted opacity-25">
                            <i class="bi bi-card-image fs-1"></i>
                        </div>
                    {% endif %}
                </div>

                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="salon-avatar me-3" style="width: 50px; height: 50px; border-radius: 12px; background: #fff; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            {% if salon.logo %}
                                <img src="{{ salon.logo.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <span class="fw-bold text-primary fs-4">{{ salon.name|slice:":1"|upper }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="flex-grow-1">
                            <h5 class="fw-bold mb-1 text-dark">{{ salon.name }}</h5>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-geo-alt-fill text-danger"></i> {{ salon.city|default:"Ubicación" }}
                            </div>
                            
                            {% if salon.is_open %}
                                <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Abierto</span>
                            {% else %}
                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">Cerrado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <h3 class="text-muted fw-light">No hay negocios registrados aún.</h3>
        </div>
        {% endfor %}
    </div>
</section>

<script>
    // Inicializar Tooltips
    document.addEventListener("DOMContentLoaded", function(){
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
    });

    // Filtro combinado (Ciudad + Nombre)
    function filtrarNegocios() {
        let ciudad = document.getElementById('ciudadSelect').value;
        let texto = document.getElementById('nombreBusqueda').value.toLowerCase();
        let items = document.querySelectorAll('.salon-item');

        items.forEach(item => {
            let itemCity = item.dataset.city;
            let itemName = item.dataset.name;
            let matchCiudad = (ciudad === 'todas' || itemCity === ciudad);
            let matchNombre = itemName.includes(texto);
            item.style.display = (matchCiudad && matchNombre) ? 'block' : 'none';
        });
    }

    // Lógica GPS (600 METROS EXACTOS)
    function usarUbicacion() {
        if (!navigator.geolocation) {
            alert("Tu navegador no soporta geolocalización.");
            return;
        }

        const btn = document.querySelector('.btn-location-pulse');
        const icon = btn.querySelector('i');
        icon.className = 'spinner-border spinner-border-sm'; // Icono cargando

        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let items = document.querySelectorAll('.salon-item');
            let encontrados = 0;

            items.forEach(item => {
                let lat = parseFloat(item.dataset.lat);
                let lng = parseFloat(item.dataset.lng);
                
                // Si el negocio no tiene coordenadas, lo ocultamos en modo GPS
                if (lat === 0 || lng === 0) {
                    item.style.display = 'none';
                    return;
                }

                let dist = getDistance(userLat, userLng, lat, lng);
                
                // *** AQUÍ ESTÁ EL CAMBIO: 0.6 KM = 600 METROS ***
                if (dist <= 0.6) { 
                    item.style.display = 'block';
                    encontrados++;
                } else {
                    item.style.display = 'none';
                }
            });

            icon.className = 'bi bi-crosshair'; // Restaurar icono

            if (encontrados > 0) {
                // Hacemos scroll hacia los resultados
                document.getElementById('salonGrid').scrollIntoView({behavior: 'smooth'});
            } else {
                alert("No encontramos negocios a menos de 600 metros de tu ubicación actual.");
                // Opcional: Mostrar todos de nuevo si no encuentra nada
                // filtrarNegocios(); 
            }

        }, error => {
            icon.className = 'bi bi-crosshair';
            alert("No pudimos obtener tu ubicación. Verifica los permisos.");
        });
    }

    // Fórmula Haversine (Devuelve Km)
    function getDistance(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radio tierra km
        var dLat = (lat2-lat1) * (Math.PI/180);
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
    }
</script>

{% endblock %}